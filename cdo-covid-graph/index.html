<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CDO COVID Tracker</title>
    <style>
        body {
            font-family: 'Lato', sans-serif;
            padding: 0;
            margin: 0;
        }
        h1, h2, h3, h4, h5 {
            margin: 0;
        }
        .container {
            display: flex;
            flex-direction: row;
        }
        #network-chart {
            flex-grow: 1;
            height: 100vh;
        }
        #info {
            max-width: 300px;
            border-left: 1px solid black;
            padding: 8px 8px;
            display: flex;
            flex-direction: column;
        }
        #case-info {
            flex-grow: 1;
            padding-top: 24px;
        }
        #case-details {
            margin: 0;
            padding-left: 21px;
        }
        .info-header {
            border-bottom: 1px solid black;
            padding-bottom: 4px;
        }
        .info-header h1 {
            text-align: center;
        }
        #chart-controls {
            display: flex;
            flex-direction: column;
            border-top: 1px solid black;
        }
        #datepicker {
            margin: 0 auto;
            padding-top: 4px;
            padding-bottom: 8px;
        }
        .section-header {
            text-align: center;
        }
        .section-body {
            display: flex;
            flex-direction: column;
            align-items: start;
        }
    </style>
</head>
<body>

<div class="container">
    <div id="network-chart"></div>
    <div id="info">
        <div class="info-header">
            <h1>CDO COVID19 CASE NETWORK</h1>
        </div>
        <div id="node-count"></div>
        <div id="case-info">
            <h3 id="case-id"></h3>
            <ul id="case-details"></ul>
        </div>
        <div id="chart-controls">
            <h3 class="section-header" >Chart Controls</h3>
            <div class="section-body">

                <label for="hide_rof">
                    <input type="checkbox" id="hide_rof" /> 
                    <svg width="10" height="10" viewBox="0 0 10 10" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect width="10" height="10" rx="8" fill="green"/>
                    </svg>
                    Hide ROF
                </label>
                <label for="hide_lsi">
                    <input type="checkbox" id="hide_lsi" />
                    <svg width="10" height="10" viewBox="0 0 10 10" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect width="10" height="10" rx="8" fill="orange"/>
                    </svg>
                    Hide LSI
                </label>
                <!-- <label for="hide_no_child">
                    <input type="checkbox" id="hide_no_child" /> Hide no connections
                </label> -->
                
                <label for="datepicker" style="padding-top: 4px;">Select a date</label>
                <div id="datepicker"></div>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js" integrity="sha512-uto9mlQzrs59VwILcLiRYeLKPPbS/bT71da/OEBYEwcdNUk8jYIy+D176RYoop1Da+f9mvkYrmj5MCLZWEtQuA==" crossorigin="anonymous"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.css" integrity="sha512-aOG0c6nPNzGk+5zjwyJaoRUgCdOrfSDhmMID2u4+OIslr0GjpLKo7Xm0Ao3xmpM4T8AmIouRkqwj1nrdVsLKEQ==" crossorigin="anonymous" />

<script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>

<script>

var covidData = $.getJSON("https://jrequiroso.github.io/cdo-covid-graph/covid-data.json");

var hide_lsi = false;
var hide_rof = false;
var hide_no_child = false;
var selected_date = '';

var with_contacts = [];
var no_connections = [];
var no_contacts = [];

var nodes = [];
var node_count = 0;
var edges = [];

for (var i = 0; i < covidData.length ; i++) {
    var original_text = covidData[i].text;
    covidData[i].child = [];

    // Getting Case #
    var case_num_string = original_text.match(/CASE #\d*:/g);
    var case_num = case_num_string[0].replace('CASE #', '').replace(':', '');
    covidData[i].case_num = parseInt(case_num);

    // Getting Age
    // NOTE: Infants aged < 1 year have been rounded up to 1
    var age_string = original_text.match(/\d*-year old/g);
    var age = age_string[0].replace('-year old', '');
    covidData[i].age = parseInt(age);
    
    // Getting Gender
    var sex_string = original_text.match(/(^|\s)male|female(\s|$)/g);
    var sex = "unspecified";

    if (sex_string != null) {
        var sex = sex_string[0].trim();
        covidData[i].sex = sex;
    }

    // Getting Case Type
    var type_string = original_text.match(/LSI|ROF|LOCAL CASE/g);
    var type = 'unspecified';

    var color = 'blue';
    if (type_string !== null)  {
        type = type_string[0].trim();
        
        switch (type) {
            case 'LSI': color = "orange"; break;
            case 'ROF': color = "green"; break;
            case 'LOCAL CASE': color = "red"; break;
        }
    }
    covidData[i].type = type;

    // Getting people in contact with
    var contacts = [];
    var string_without_case_prefix = covidData[i].text.replace(/CASE #\d*:/g, '');
    var in_contact_with_string = string_without_case_prefix.match(/CASE #\d*/gi, '');
    if (in_contact_with_string !== null) {
        for (var j = 0 ; j < in_contact_with_string.length ; j++) {
            var contact_case_num = parseInt(in_contact_with_string[j].replace('CASE #', '').replace('case #', '').replace('Case #', '').trim());

            // check first if already in array
            if (!contacts.includes(contact_case_num)) {
                contacts.push(contact_case_num);
            }
        }
    }

    covidData[i].contacts = contacts;
    if (contacts.length > 0) {
        with_contacts.push(covidData[i]);
    } else {
        no_contacts.push(covidData[i]);
    }

    nodes.push({ 
        id: parseInt(case_num), 
        label: "Case #" + case_num,
        title: covidData[i].original_text,
        color: color,
        caseType: type.replace(" ", '-'),
        font: {
            color: 'white',
            face: 'Lato',
        }
    });
    /* location:  "from xxxxxx" */
}

for (var i = 0; i < with_contacts.length ; i++) {
    var current_case = with_contacts[i];

    for (var j = 0; j < current_case.contacts.length ; j++) {
        var parent_case_num = current_case.contacts[j];

        var parent_case = covidData.filter( case1 => {
            return case1.case_num == parent_case_num;
        })[0]

        if (parent_case != undefined) {
            // push to parent case
            /* covidData.filter( case1 => {
                return case1.case_num == parent_case_num;
            })[0].child.push(current_case); */

            edges.push({from: parent_case_num, to: current_case.case_num})
        }
    }
}

// create a network
var container = document.getElementById('network-chart');

// provide the data in the vis format
var data = {
    nodes: nodes,
    edges: edges
};
node_count = nodes.length;
$('#node-count').html(node_count + " patients (262 not included)<br/> <strong>" + (262 + node_count) + ' TOTAL </strong>');

var options = {
    height: '100%',
    width: '100%',
    layout: {
        randomSeed: 1,
        improvedLayout: true,
    },
};

var resetSelectedCase = () => {    
    document.getElementById('case-id').innerHTML = '';
    document.getElementById('case-details').innerHTML = '';
}

// initialize your network!
var network = new vis.Network(container, data, options);
network.on( 'click', properties => {    
    // clear info
    resetSelectedCase();

    if (properties.nodes.length > 0) {
        var id = properties.nodes[0];
        var selected_case = covidData.filter( selected_case => {
            return selected_case.case_num == id;
        })[0];
        
        document.getElementById('case-id').innerHTML = "CASE #" + selected_case.case_num

        var details = selected_case.text.replace(/CASE #\d*:/g, '').split(';')
        var detailsHTML;

        for(var i = 0 ; i < details.length ; i++) {
            detailsHTML = document.createElement('li');
            detailsHTML.textContent = details[i];
            document.getElementById('case-details').append(detailsHTML)
        }
    }
});

var filterNodesAndRedraw = () => {
    var dataCopy = covidData;
    var filteredNodes = [];

    dataCopy = dataCopy.filter(datarow => {
        return new Date(datarow.added) <= new Date($("#datepicker").val());
    })

    if (hide_lsi) {
        dataCopy = dataCopy.filter(datarow => {
            return datarow.type != 'LSI'
        })
    }

    if (hide_rof) {
        dataCopy = dataCopy.filter(datarow => {
            return datarow.type != 'ROF'
        })
    }

    if (hide_no_child) {
        /* dataCopy = dataCopy.filter(datarow => {
            return datarow.type != 'ROF'
        }) */
    }

    for (var i = 0; i < dataCopy.length ; i++) {
        var color = 'blue';
        switch (dataCopy[i].type) {
            case 'LSI': color = "orange"; break;
            case 'ROF': color = "green"; break;
            case 'LOCAL CASE': color = "red"; break;
        }

        filteredNodes.push({ 
            id: parseInt(dataCopy[i].case_num), 
            label: "Case #" + dataCopy[i].case_num,
            title: dataCopy[i].original_text,
            color: color,
            caseType: dataCopy[i].type.replace(" ", '-'),
            font: {
                color: 'white',
                face: 'Lato',
            }
        });
    }    

    network.setOptions(options);
    network.setData({ nodes: filteredNodes, edges });
    network.redraw();
    node_count = filteredNodes.length;
    $('#node-count').html(node_count + " patients (262 not included)<br/> <strong>" + (262 + node_count) + ' TOTAL</strong>');
}

$( document ).ready(function() {
    $( "#datepicker" ).datepicker({
        dateFormat: "yy-mm-dd",
        minDate: "2020-08-27",
        maxDate: '0',
        beforeShowDay: function(date){
            var string = jQuery.datepicker.formatDate('yy-mm-dd', date);
            return [ ["2020-08-30", "2020-09-06", "2020-09-13"] .indexOf(string) == -1 ]
        }
    }).on("input change", function (e) {
        filterNodesAndRedraw();
    });
    $("#hide_rof").change(function () {
        hide_rof = false;
        if (this.checked) hide_rof = true;
        filterNodesAndRedraw();
    });

    $("#hide_lsi").change(function () {
        hide_lsi = false;
        if (this.checked) hide_lsi = true;
        filterNodesAndRedraw();
    });

    $("#hide_no_child").change(function () {
        hide_no_child = false;
        if (this.checked) hide_no_child = true;
        filterNodesAndRedraw();
    });
});
</script>
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
<link href="https://fonts.googleapis.com/css2?family=Lato:ital,wght@0,100;0,300;0,400;0,700;0,900;1,100;1,300;1,400;1,700;1,900&display=swap" rel="stylesheet">
</body>
</html>